

### **مستندات فنی پروژه: افزونه چت‌بات پزشکی برای وردپرس**

این مستندات به منظور ارائه یک راهنمای فنی عمیق برای توسعه‌دهندگان تهیه شده است تا با معماری، عملکرد و جزئیات پیاده‌سازی افزونه چت‌بات وردپرس آشنا شوند.

#### **۱. نمای کلی پروژه**

**هدف پروژه:**
این افزونه یک رابط کاربری چت تمام‌صفحه را از طریق یک کد کوتاه (Shortcode) به وب‌سایت‌های وردپرسی اضافه می‌کند. این افزونه به عنوان یک **واسط (Proxy)** عمل می‌کند؛ یعنی درخواست‌ها را از کاربر دریافت کرده و آن‌ها را به یک سرویس بک‌اند خارجی (که با FastAPI ساخته شده) ارسال می‌کند و پاسخ را به کاربر نمایش می‌دهد. این معماری، منطق سنگین پردازش زبان را از وب‌سایت وردپرس جدا می‌سازد.

**ویژگی‌های اصلی:**
*   **رابط کاربری تمام‌صفحه:** با استفاده از کد کوتاه `[medical_chatbot]`، یک محیط چت کامل شامل سایدبار تاریخچه گفتگو و پنجره اصلی چت ایجاد می‌شود.
*   **تاریخچه گفتگو:** برای کاربران وارد شده، لیست جلسات گفتگوی قبلی در سایدبار نمایش داده می‌شود و کاربر می‌تواند با کلیک بر روی هرکدام، تاریخچه آن را مشاهده کند.
*   **مدیریت جلسه (Session):** هر گفتگو دارای یک شناسه منحصر به فرد است که امکان تفکیک و بازیابی مکالمات را فراهم می‌کند.
*   **معماری واسط (Proxy):** افزونه به جای پردازش مستقیم، درخواست‌های چت، تاریخچه و لیست جلسات را به یک API خارجی ارسال می‌کند. این کار بار پردازشی را از روی سرور وردپرس برمی‌دارد.
*   **بارگذاری بهینه منابع:** فایل‌های CSS و JavaScript افزونه تنها در صفحاتی بارگذاری می‌شوند که از کد کوتاه `[medical_chatbot]` استفاده کرده باشند.

**پشته فناوری (Technology Stack):**
*   **سمت سرور (Backend - WordPress):** PHP برای منطق افزونه، ثبت کد کوتاه و ایجاد نقاط پایانی REST API به عنوان واسط.
*   **سمت کاربر (Frontend):** Vanilla JavaScript برای مدیریت کامل تعاملات کاربر، HTML برای ساختار و CSS برای استایل‌دهی.
*   **وابستگی‌ها:**
    *   `marked.js`: برای تبدیل پاسخ‌های Markdown از سرور به HTML قابل نمایش.

---

#### **۲. راه‌اندازی و استفاده**

**مراحل نصب:**
1.  پوشه medical_chatbot_plugin را در مسیر `wp-content/plugins/` در نصب وردپرس خود قرار دهید.
2.  از طریق پنل مدیریت وردپرس به بخش **افزونه‌ها > افزونه‌های نصب شده** بروید.
3.  افزونه **"Medical Chatbot"** را پیدا کرده و آن را **فعال** کنید.

**نحوه استفاده:**
برای نمایش رابط کاربری چت‌بات در یک صفحه، کافی است کد کوتاه `[medical_chatbot]` را در ویرایشگر آن صفحه قرار دهید.

---

#### **۳. تحلیل اجزا و عملکرد کد**

**۱. فایل اصلی افزونه (chatbot_plugin.php)**

این فایل مرکز کنترل افزونه است و وظیفه ثبت منابع، مسیرها و کد کوتاه را بر عهده دارد.

*   **عملکرد کلی:**
    *   **بارگذاری مشروط منابع (`mcb_enqueue_assets`):** این تابع بررسی می‌کند که آیا کد کوتاه `[medical_chatbot]` در صفحه فعلی وجود دارد یا خیر. در صورت وجود، فایل‌های chatbot-style.css, `marked.min.js` و chatbot-script.js را به صفحه اضافه می‌کند.
    *   **انتقال داده به جاوااسکریپت (`wp_localize_script`):** اطلاعات مهمی مانند آدرس REST API وردپرس (`api_url`)، شناسه کاربر (`user_id`) و یک توکن امنیتی (`nonce`) را به صورت یک آبجکت جاوااسکریپتی به نام `mcb_params` در دسترس اسکریپت سمت کاربر قرار می‌دهد.
    *   **تعریف API خارجی:** آدرس سرویس بک‌اند اصلی در ثابت `MCB_EXTERNAL_API_URL` تعریف شده است.
    *   **ثبت مسیرهای REST API به عنوان واسط (`mcb_register_rest_routes`):** این افزونه سه مسیر REST API سفارشی در وردپرس ایجاد می‌کند:
        1.  `POST /mcb/v1/chat`: درخواست چت را از کلاینت دریافت و آن را به `MCB_EXTERNAL_API_URL/api/chat/` ارسال (پراکسی) می‌کند.
        2.  `GET /mcb/v1/history/<session_id>`: درخواست تاریخچه یک جلسه را به `MCB_EXTERNAL_API_URL/api/history/<session_id>` پراکسی می‌کند.
        3.  `GET /mcb/v1/sessions`: درخواست لیست جلسات کاربر را به `MCB_EXTERNAL_API_URL/api/sessions/<user_id>` پراکسی می‌کند.
        این توابع (`mcb_handle_*_request`) از توابع `wp_remote_post` و `wp_remote_get` وردپرس برای برقراری ارتباط با API خارجی استفاده می‌کنند.
    *   **رندر کردن HTML با کد کوتاه (`mcb_chatbot_shortcode`):** این تابع ساختار کامل HTML رابط کاربری چت (شامل سایدبار تاریخچه، پنجره پیام‌ها، فرم ورودی و...) را تولید می‌کند.

**۲. اسکریپت سمت کاربر (chatbot-script.js)**

این فایل با استفاده از Vanilla JavaScript، تمام منطق تعاملی سمت کاربر را مدیریت می‌کند.

*   **عملکرد کلی:**
    *   **مقداردهی اولیه:** پس از بارگذاری کامل DOM، اسکریپت اجرا شده و به عناصر اصلی (فرم، ورودی متن، کانتینر پیام‌ها) دسترسی پیدا می‌کند. همچنین متغیرهای ارسال شده از PHP (آبجکت `mcb_params`) را می‌خواند.
    *   **مدیریت جلسه (`currentSessionId`):** یک شناسه جلسه منحصر به فرد با `crypto.randomUUID()` برای هر گفتگوی جدید ایجاد می‌شود.
    *   **بارگذاری لیست جلسات (`loadSessionList`):** در ابتدای کار، این تابع فراخوانی می‌شود تا با ارسال درخواست به مسیر `/mcb/v1/sessions` (که به بک‌اند اصلی پراکسی می‌شود)، لیست گفتگوهای قبلی کاربر را دریافت و در سایدبار نمایش دهد.
    *   **شروع گفتگوی جدید (`startNewChat`):** با کلیک روی دکمه "گفتگوی جدید"، یک `currentSessionId` جدید تولید شده و پنجره چت به حالت اولیه بازنشانی می‌شود.
    *   **بارگذاری تاریخچه جلسه (`loadSession`):** با کلیک روی یکی از آیتم‌های تاریخچه، این تابع تاریخچه کامل آن جلسه را از مسیر `/mcb/v1/history/<session_id>` دریافت و در پنجره چت نمایش می‌دهد.
    *   **ارسال پیام (`chatForm.addEventListener('submit', ...)`):**
        1.  هنگام ارسال فرم، پیام کاربر خوانده شده و در پنجره چت نمایش داده می‌شود.
        2.  انیمیشن "در حال نوشتن..." نمایش داده می‌شود.
        3.  یک درخواست `fetch` از نوع `POST` به مسیر `/mcb/v1/chat` ارسال می‌شود. بدنه درخواست شامل پیام کاربر، `session_id` فعلی و `user_id` است.
        4.  پس از دریافت پاسخ از سرور، انیمیشن متوقف شده و پاسخ ربات (که با `marked.parse()` به HTML تبدیل شده) در پنجره نمایش داده می‌شود.
        5.  در صورت بروز خطا، پیام مناسبی به کاربر نمایش داده می‌شود.

**۳. استایل‌ها (chatbot-style.css)**

این فایل مسئول ظاهر کلی رابط کاربری چت است.

*   **عملکرد کلی:**
    *   **طراحی تمام‌صفحه:** با استفاده از کلاس `mcb-body-fullscreen` که به تگ `body` اضافه می‌شود، اسکرول صفحه غیرفعال شده و محیط چت بخش بزرگی از صفحه را اشغال می‌کند.
    *   **چیدمان Flexbox:** ساختار اصلی رابط کاربری (سایدبار و پنجره چت) با استفاده از Flexbox پیاده‌سازی شده است تا در حالت دسکتاپ کنار هم و در حالت موبایل روی هم قرار گیرند.
    *   **استایل پیام‌ها:** پیام‌های کاربر و ربات دارای استایل‌های متفاوتی هستند (رنگ پس‌زمینه، جهت قرارگیری و شکل حباب پیام) تا به راحتی قابل تشخیص باشند.
    *   **طراحی واکنش‌گرا (Responsive):** با استفاده از Media Query ها، چیدمان و اندازه عناصر برای نمایشگرهای کوچکتر (مانند موبایل) بهینه‌سازی شده است. برای مثال، سایدبار به بالای صفحه منتقل شده و عرض کمتری را اشغال می‌کند.
    *   **فونت سفارشی:** فونت "Estedad-FD" با استفاده از `@font-face` برای خوانایی بهتر متون فارسی در کل رابط کاربری تعریف و استفاده شده است.



#### **۴. اتصال افزونه وردپرس به سرویس بک‌اند پایتون**

برای اینکه چت‌بات به درستی کار کند، افزونه وردپرس (کلاینت) باید بتواند با سرویس بک‌اند پایتون (سرور) ارتباط برقرار کند. افزونه وردپرس به عنوان یک واسط عمل می‌کند و تمام درخواست‌ها را به آدرس سرور پایتون ارسال می‌نماید. برای برقراری این اتصال، مراحل زیر را دنبال کنید.

**مرحله ۱: اجرای سرویس بک‌اند پایتون**

ابتدا مطمئن شوید که برنامه FastAPI پایتون شما در حال اجرا و از طریق شبکه قابل دسترسی است.
*   **برای توسعه محلی (Local Development):** اگر وردپرس و سرور پایتون هر دو روی یک کامپیوتر اجرا می‌شوند، سرور پایتون به طور پیش‌فرض روی آدرسی مانند `http://127.0.0.1:8000` یا `http://localhost:8000` در دسترس خواهد بود.
*   **برای محیط عملیاتی (Production):** شما باید برنامه پایتون را روی یک سرور مستقر (Deploy) کنید تا یک URL عمومی و قابل دسترس داشته باشد. برای مثال: `https://chatbot.asamapp.ir`.

**مرحله ۲: پیکربندی آدرس API در افزونه وردپرس**

افزونه وردپرس باید بداند که درخواست‌ها را به کجا ارسال کند. این آدرس در فایل اصلی افزونه تعریف شده است.

1.  فایل `chatbot_plugin.php` را در مسیر medical_chatbot_plugin باز کنید.
2.  خطی که ثابت `MCB_EXTERNAL_API_URL` را تعریف می‌کند، پیدا کنید.
3.  آدرس پیش‌فرض را با آدرس واقعی سرویس بک‌اند پایتون خود (از مرحله ۱) جایگزین کنید.

````php
// ...existing code...
/**
 * The external API base URL.
 * 
 * مهم: این آدرس را به URL سرویس بک‌اند پایتون (FastAPI) خود تغییر دهید.
 */
define('MCB_EXTERNAL_API_URL', 'http://127.0.0.1:8000'); // مثال برای توسعه محلی

// یا برای محیط عملیاتی
// define('MCB_EXTERNAL_API_URL', 'https://chatbot.yourdomain.com');

/**
 * Registers the custom REST API routes for the chatbot.
 */
// ...existing code...
````
**نکته:** مطمئن شوید که در انتهای آدرس، کاراکتر `/` وجود **نداشته باشد**. افزونه به صورت خودکار مسیرهای `/api/chat` و ... را به این آدرس اضافه می‌کند.

**مرحله ۳: پیکربندی CORS در سرویس بک‌اند**

به دلایل امنیتی، سرورهای وب به طور پیش‌فرض درخواست‌هایی را که از دامنه‌های دیگر می‌آیند، مسدود می‌کنند. شما باید به سرور FastAPI خود بگویید که درخواست‌های ارسالی از دامنه سایت وردپرسی شما مجاز هستند.

1.  فایل main.py را در پروژه پایتون خود باز کنید.
2.  لیست `origins` را پیدا کنید.
3.  آدرس دامنه سایت وردپرسی خود را به این لیست اضافه کنید.

````python
// ...existing code...
# CORS middleware
# مهم: برای محیط عملیاتی، باید آدرس‌ها را به دامنه واقعی وردپرس خود محدود کنید.
origins = [
    "http://your-wordpress-site.com",
    "https://your-wordpress-site.com",
    # برای توسعه محلی، ممکن است به آدرس‌های زیر نیاز داشته باشید
    "http://localhost",
    "http://localhost:8080", # اگر وردپرس روی پورت دیگری اجرا می‌شود
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
// ...existing code...
````
پس از انجام این سه مرحله، افزونه وردپرس شما باید بتواند با موفقیت به سرویس بک‌اند متصل شده و چت‌بات به درستی کار کند. برای اطمینان، می‌توانید صفحه چت را در سایت وردپرس خود باز کرده و در بخش Network در ابزارهای توسعه‌دهنده مرورگر (Developer Tools)، درخواست‌های ارسال شده به مسیر `wp-json/mcb/v1/chat` را بررسی کنید و مطمئن شوید که با کد وضعیت `200 OK` پاسخ داده می‌شوند.


#### **۵. پیکربندی Reverse Proxy با Nginx (اختیاری اما پیشنهادی)**

در یک محیط عملیاتی (Production)، اجرای مستقیم برنامه پایتون از طریق Uvicorn به تنهایی کافی نیست. استفاده از یک وب سرور مانند Nginx به عنوان **Reverse Proxy** در جلوی برنامه FastAPI شما، مزایای بسیاری از جمله افزایش امنیت، مدیریت اتصالات، فشرده‌سازی، و مهم‌تر از همه، قابلیت مدیریت HTTPS (SSL/TLS) را فراهم می‌کند.

این راهنما فرض می‌کند که شما Nginx را روی سرور خود نصب کرده‌اید.

**مرحله ۱: اجرای برنامه FastAPI با Gunicorn**

برای محیط عملیاتی، بهتر است از یک سرور WSGI/ASGI مانند Gunicorn برای مدیریت فرآیندهای برنامه پایتون خود استفاده کنید. Gunicorn برنامه شما را اجرا کرده و آن را روی یک پورت داخلی (مانند `8000`) در دسترس قرار می‌دهد.

1.  ابتدا Gunicorn را نصب کنید:
    ```bash
    pip install gunicorn
    ```
2.  از ریشه پروژه، برنامه خود را با دستور زیر اجرا کنید:
    ```bash
    gunicorn -w 4 -k uvicorn.workers.UvicornWorker src.main:app -b 127.0.0.1:8000
    ```
    *   `-w 4`: تعداد فرآیندهای کارگر (worker processes) را مشخص می‌کند (معمولاً ۲ تا ۴ برابر تعداد هسته‌های CPU).
    *   `-k uvicorn.workers.UvicornWorker`: به Gunicorn می‌گوید که از کارگرهای Uvicorn برای اجرای برنامه‌های ASGI استفاده کند.
    *   `-b 127.0.0.1:8000`: برنامه را فقط روی `localhost` و پورت `8000` اجرا می‌کند تا فقط Nginx بتواند به آن دسترسی داشته باشد.

**مرحله ۲: ایجاد فایل پیکربندی Nginx**

حالا باید یک فایل پیکربندی برای سایت چت‌بات خود در Nginx ایجاد کنید.

1.  یک فایل جدید در مسیر `/etc/nginx/sites-available/` ایجاد کنید. نام آن را `chatbot` یا نام دلخواه دیگری بگذارید.
    ```bash
    sudo nano /etc/nginx/sites-available/chatbot
    ```
2.  پیکربندی زیر را در این فایل کپی کنید و `chatbot.yourdomain.com` را با دامنه یا زیردامنه واقعی خود جایگزین نمایید.

````nginx
server {
    listen 80;
    server_name chatbot.yourdomain.com; # دامنه خود را اینجا وارد کنید

    location / {
        # ارسال درخواست‌ها به سرور Gunicorn که روی پورت 8000 در حال اجراست
        proxy_pass http://127.0.0.1:8000;

        # تنظیم هدرهای ضروری برای اینکه FastAPI اطلاعات صحیح کلاینت را دریافت کند
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
````

**مرحله ۳: فعال‌سازی سایت و راه‌اندازی مجدد Nginx**

1.  یک لینک نمادین (Symbolic Link) از فایل پیکربندی خود به پوشه `sites-enabled` ایجاد کنید تا Nginx آن را بارگذاری کند.
    ```bash
    sudo ln -s /etc/nginx/sites-available/chatbot /etc/nginx/sites-enabled/
    ```
2.  پیکربندی Nginx را برای اطمینان از عدم وجود خطا تست کنید.
    ```bash
    sudo nginx -t
    ```
    اگر خروجی `syntax is ok` و `test is successful` را مشاهده کردید، همه چیز درست است.

3.  سرویس Nginx را برای اعمال تغییرات راه‌اندازی مجدد کنید.
    ```bash
    sudo systemctl restart nginx
    ```

**مرحله ۴: تنظیم HTTPS با Certbot (بسیار مهم)**

استفاده از HTTPS برای رمزنگاری ارتباط بین کلاینت و سرور ضروری است. ساده‌ترین راه برای دریافت و نصب گواهی SSL رایگان، استفاده از Certbot است.

1.  Certbot و پلاگین Nginx آن را نصب کنید (دستور ممکن است بسته به توزیع لینوکس شما متفاوت باشد).
    ```bash
    # برای اوبونتو/دبیان
    sudo apt update
    sudo apt install certbot python3-certbot-nginx
    ```
2.  دستور زیر را برای دریافت و نصب خودکار گواهی SSL برای دامنه خود اجرا کنید.
    ```bash
    sudo certbot --nginx -d chatbot.yourdomain.com
    ```
    Certbot از شما چند سوال می‌پرسد و سپس به طور خودکار فایل پیکربندی Nginx شما (`/etc/nginx/sites-available/chatbot`) را برای مدیریت HTTPS و ریدایرکت کردن ترافیک HTTP به HTTPS ویرایش می‌کند.

**مرحله نهایی: به‌روزرسانی آدرس در افزونه وردپرس**

اکنون که سرویس بک‌اند شما از طریق یک دامنه عمومی و امن (`https://chatbot.yourdomain.com`) در دسترس است، باید این آدرس را در افزونه وردپرس خود به‌روز کنید.

به **مرحله ۲** از بخش قبلی ("اتصال افزونه وردپرس به سرویس بک‌اند") بازگردید و ثابت `MCB_EXTERNAL_API_URL` را در فایل `chatbot_plugin.php` به آدرس جدید و کامل (با `https`) تغییر دهید:

````php
define('MCB_EXTERNAL_API_URL', 'https://chatbot.yourdomain.com');
````

با انجام این مراحل، شما یک معماری قوی و امن برای چت‌بات خود پیاده‌سازی کرده‌اید.